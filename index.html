<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oregon Fire Ops | Command Dashboard</title>
    <style>
        :root {
            --bg-dark: #080808; --panel-bg: #121212; --fire-red: #cc3333; 
            --directory-yellow: #ffff00; --timestamp-cyan: #00f2ff;
            --btn-light-gray: #3a3a3a; --terminal-green: #00ff00;
        }

        body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--bg-dark); color: #e0e0e0; overflow: hidden; display: flex; flex-direction: column; height: 100vh; }
        
        header { 
            background: #000; padding: 12px 25px; border-bottom: 3px solid var(--fire-red); 
            flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; position: relative;
        }

        .version-tag { position: absolute; bottom: 2px; right: 10px; font-size: 0.65rem; color: #444; font-family: monospace; font-weight: bold; }

        .main-wrapper { display: grid; grid-template-columns: 1fr 380px; gap: 12px; padding: 12px; flex-grow: 1; overflow: hidden; }
        
        /* === CALL NOTES TERMINAL (Pinned Bottom) === */
        #terminal-wrapper {
            display: flex;
            flex-direction: column;
            margin-top: 10px;
            border: 1px solid #333;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
            height: 140px; /* Slightly taller for better typing space */
        }

        #call-notes {
            background: #000;
            color: var(--terminal-green);
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.95rem;
            padding: 10px;
            border: none;
            width: 100%;
            height: 100px;
            resize: none;
            outline: none;
            box-sizing: border-box;
        }

        #debug-log {
            background: #000;
            color: var(--terminal-green);
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.75rem;
            padding: 5px 10px;
            border-top: 1px solid #222;
            height: 40px;
            overflow-y: auto;
            opacity: 0.8;
        }
        
        .left-side { display: flex; flex-direction: column; overflow: hidden; }
        .command-bar { 
            background: #1a1a1a; padding: 15px; border-radius: 6px; border: 1px solid #333; 
            display: flex; gap: 12px; align-items: center; flex-shrink: 0; margin-bottom: 10px;
        }

        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; align-content: start; overflow-y: auto; flex-grow: 1; }

        /* === UNIT CARD === */
        .unit-card { 
            position: relative; background-color: transparent !important; 
            border: 1px solid rgba(255,255,255,0.2); border-top: 5px solid var(--fire-red); 
            border-radius: 4px; padding: 10px; min-height: 200px; z-index: 1; overflow: hidden;
        }

        .card-background {
            position: absolute; inset: 0; z-index: 0;
            background-repeat: no-repeat; background-position: center;
            background-size: 80% auto; opacity: 0.25;
            filter: brightness(1.15) contrast(1.05); pointer-events: none;
        }

        .card-content { position: relative; z-index: 10; pointer-events: auto; }
        .unit-name { font-size: 1.35rem; font-weight: 900; color: #fff; text-shadow: 2px 2px 4px #000; }
        .unit-location { font-size: 0.95rem; color: var(--directory-yellow); font-weight: 900; text-shadow: 1px 1px 2px #000;}
        
        .status-btn { width: 100%; padding: 10px; font-weight: 900; margin-top: 8px; color: white; cursor: pointer; border-radius: 4px; text-transform: uppercase; border: 1px solid rgba(255,255,255,0.2); background: #7a5d00; }
        
        .ts-grid { display: flex; justify-content: space-between; margin-top: 8px; border-top: 1px solid #444; padding-top: 6px; }
        .ts-box { text-align: center; flex: 1; }
        .ts-label { font-size: 0.6rem; color: var(--timestamp-cyan); font-weight: bold; display: block; }
        .ts-val { font-family: monospace; font-size: 1.1rem; font-weight: 900; color: #fff; }

        /* === DIRECTORY === */
        .column { background: var(--panel-bg); border-radius: 6px; display: flex; flex-direction: column; border: 1px solid #222; overflow: hidden; }
        .scroll-area { padding: 12px; overflow-y: auto; flex-grow: 1; }

        .unit-btn { 
            position: relative; padding: 10px 4px; color: #fff; font-weight: 900; 
            background: var(--btn-light-gray) !important; border: 1px solid #555 !important; 
            border-radius: 4px; cursor: pointer; font-size: 11px; overflow: hidden; margin-bottom: 4px;
            transition: background 0.2s, border-color 0.2s;
        }
        .unit-btn:hover { background: #4a4a4a !important; border-color: var(--fire-red) !important; }
        .unit-btn span { position: relative; z-index: 5; pointer-events: none; }
        .unit-btn .btn-bg { 
            position: absolute; inset: 0; background-repeat: no-repeat; 
            background-position: center; background-size: contain; opacity: 0.18; 
            pointer-events: none; filter: saturate(1.3) brightness(1.05); 
        }

        .accordion-header { background: #1a1a1a; padding: 12px; font-weight: 800; border-bottom: 1px solid #000; cursor: pointer; border-left: 8px solid #444; }
        .cat-label { font-size: 0.65rem; font-weight: bold; color: #aaa; text-transform: uppercase; border-bottom: 1px solid #333; margin: 10px 0 4px; }
        .is-hidden { display: none !important; }

        .cmd-input { background: #000; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 4px; outline: none; }
        .cmd-input:focus { border-color: var(--fire-red); }
        optgroup { background: #1a1a1a; color: var(--fire-red); font-weight: bold; }
        option { background: #000; color: #fff; }
    </style>
</head>
<body>

<header>
    <div style="font-weight: 900; font-size: 1.2rem;">OREGON <span style="color:var(--fire-red)">COMMAND DASHBOARD</span></div>
    <div id="clock" style="font-family: monospace; font-size: 1.4rem; font-weight: 900;">00:00:00</div>
    <div class="version-tag">V 0.0.1013</div>
</header>

<div class="main-wrapper">
    <div class="left-side">
        <div class="command-bar">
            <input type="text" class="cmd-input" style="flex: 2;" placeholder="INCIDENT ADDRESS">
            <select class="cmd-input" style="flex: 1.2;">
                <option value="">OPS CHANNEL</option>
                <optgroup label="MULTNOMAH">
                    <option>OPS 1</option><option>OPS 2</option><option>OPS 3</option>
                    <option>OPS 4</option><option>OPS 5</option><option>OPS 6</option>
                    <option>OPS 7</option><option>OPS 8</option><option>OPS 9</option>
                    <option>OPS 10</option><option>OPS 11</option><option>OPS 12</option>
                </optgroup>
                <optgroup label="CLACKAMAS">
                    <option>OPS 22</option><option>OPS 23</option><option>OPS 24</option>
                    <option>OPS 25</option><option>OPS 26</option><option>OPS 27</option>
                    <option>OPS 28</option>
                </optgroup>
                <optgroup label="WASHINGTON">
                    <option>OPS 32</option><option>OPS 33</option><option>OPS 34</option>
                    <option>OPS 35</option><option>OPS 36</option><option>OPS 37</option>
                    <option>OPS 38</option>
                </optgroup>
                <optgroup label="INTEROP">
                    <option>V-FIRE 21</option><option>V-FIRE 22</option>
                </optgroup>
            </select>
            <button onclick="resetBoard()" style="background:var(--fire-red); color:white; border:none; padding:10px 15px; border-radius:4px; font-weight:900; cursor:pointer;">RESET</button>
        </div>

        <div class="dashboard-grid" id="active-units"></div>

        <div id="terminal-wrapper">
            <textarea id="call-notes" placeholder="TYPE CALL NOTES HERE..."></textarea>
            <div id="debug-log">V 0.0.1013: NATURAL SORT ONLINE</div>
        </div>
    </div>
    
    <div class="column">
        <div class="search-container" style="padding:10px; background:#000;">
            <input type="text" id="unit-search" class="cmd-input" style="width:100%;" placeholder="SEARCH UNIT OR AGENCY..." onkeyup="filterUnits()">
        </div>
        <div class="scroll-area" id="accordion-container"></div>
    </div>
</div>

<script>
    const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbxnraVlT1hIJev-o2oS3mAxooAyOVVh0IwjmeJ--T3zZTleFTp_Rue30TdAwvSf1jqZOA/exec";

    function log(msg) { 
        const logBox = document.getElementById('debug-log');
        logBox.innerHTML = `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>` + logBox.innerHTML; 
    }

    function resetBoard() {
        if(confirm("Clear all active units?")) {
            document.getElementById('active-units').innerHTML = "";
            document.getElementById('call-notes').value = "";
            log("BOARD CLEARED");
        }
    }

    function cleanGitHubUrl(url) {
        if (!url || typeof url !== 'string') return "";
        let clean = url.trim();
        try {
            while (clean.includes('%')) {
                let decoded = decodeURIComponent(clean);
                if (decoded === clean) break;
                clean = decoded;
            }
        } catch (e) { }
        if (clean.includes("github.com") && clean.includes("/blob/")) {
            clean = clean.replace("github.com", "raw.githubusercontent.com").replace("/blob/", "/");
        }
        return encodeURI(clean).replace(/'/g, "\\'");
    }

    function fetchData() {
        const s = document.createElement('script');
        s.src = `${GOOGLE_URL}?callback=setup&ts=${Date.now()}`;
        document.body.appendChild(s);
    }

    window.setup = function(raw) {
        let rows = Array.isArray(raw) ? raw : (raw.data || []);
        if (rows.length < 1) return;

        // 1. Map the data
        window.unitMap = rows.slice(1).map(row => ({
            id: String(row[0] || "").toUpperCase(),
            name: String(row[2] || ""),
            station: String(row[3] || "Unknown"),
            agency: String(row[5] || ""), 
            type: String(row[6] || "Other"),
            logoUrl: cleanGitHubUrl(row[8]) 
        })).filter(u => u.name);

        // 2. Perform NATURAL SORT (Alphanumeric: 1, 2, 10...)
        window.unitMap.sort((a, b) => 
            a.name.localeCompare(b.name, undefined, { numeric: true, sensitivity: 'base' })
        );

        log(`SUCCESS: ${window.unitMap.length} UNITS LOADED.`);
        render();
    }

    function render() {
        const container = document.getElementById('accordion-container');
        container.innerHTML = "";
        const typeOrder = ["ENGINE", "TRUCK", "MEDIC", "CHIEF", "SQUAD", "RESCUE", "TENDER", "BRUSH", "MARINE", "REHAB", "SPECIAL", "HAZMAT", "RESERVE"];
        const counties = [
            { name: "MULTNOMAH", key: "MULTNOMAH", color: "#346094" },
            { name: "CLACKAMAS", key: "CLACKAMAS", color: "#2e5a2e" },
            { name: "WASHINGTON", key: "WASHINGTON", color: "#6a0dad" }
        ];

        counties.forEach(county => {
            const h = document.createElement('div');
            h.className = `accordion-header`;
            h.style.borderLeftColor = county.color;
            h.innerHTML = `<span>${county.name}</span>`;
            const content = document.createElement('div');
            content.className = "is-hidden";
            content.style.padding = "10px";
            h.onclick = () => content.classList.toggle('is-hidden');
            container.appendChild(h); container.appendChild(content);

            typeOrder.forEach(type => {
                const units = window.unitMap.filter(u => u.id.includes(county.key) && (u.type.toUpperCase() === type));
                if (units.length > 0) {
                    const label = document.createElement('div'); label.className = 'cat-label'; label.innerText = type; content.appendChild(label);
                    const grid = document.createElement('div'); grid.style.display = "grid"; grid.style.gridTemplateColumns = "repeat(3, 1fr)"; grid.style.gap = "5px";
                    units.forEach(u => {
                        const b = document.createElement('button');
                        b.className = "unit-btn";
                        b.setAttribute('data-agency', u.agency.toUpperCase());
                        b.setAttribute('data-unit', u.name.toUpperCase());
                        b.setAttribute('data-id', u.id.toUpperCase());
                        const bgStyle = u.logoUrl ? `style="background-image: url('${u.logoUrl}')"` : "";
                        b.innerHTML = `<div class="btn-bg" ${bgStyle}></div><span>${u.name}</span>`;
                        b.onclick = () => addCard(u);
                        grid.appendChild(b);
                    });
                    content.appendChild(grid);
                }
            });
        });
    }

    function addCard(u) {
        const dash = document.getElementById('active-units');
        const card = document.createElement('div');
        card.className = 'unit-card';
        const timeNow = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12: false});
        const bgStyle = u.logoUrl ? `style="background-image: url('${u.logoUrl}')"` : "";

        card.innerHTML = `
            <div class="card-background" ${bgStyle}></div>
            <div class="card-content">
                <div style="display:flex; justify-content:space-between;">
                    <div class="unit-name">${u.name}</div>
                    <div class="unit-location">${u.station}</div>
                </div>
                <button class="status-btn" onclick="cycleStatus(this)">DISPATCHED</button>
                <div class="ts-grid">
                    <div class="ts-box"><span class="ts-label">DISP</span><span class="ts-val">${timeNow}</span></div>
                    <div class="ts-box"><span class="ts-label">ENRT</span><span class="ts-val" id="enrt">--:--</span></div>
                    <div class="ts-box"><span class="ts-label">SCNE</span><span class="ts-val" id="scne">--:--</span></div>
                </div>
                <textarea style="width:100%; background:rgba(0,0,0,0.7); color:white; border:1px solid #444; margin-top:10px; height:50px; resize:none; box-sizing:border-box;" placeholder="NOTES"></textarea>
            </div>`;
        
        dash.prepend(card);
    }

    function cycleStatus(btn) {
        const card = btn.closest('.unit-card');
        const timeNow = new Date().toLocaleTimeString('en-US', {hour:'2-digit', minute:'2-digit', hour12: false});
        if (btn.innerText === "DISPATCHED") { 
            btn.style.background = "#004d99"; btn.innerText = "EN ROUTE"; 
            card.querySelector('#enrt').innerText = timeNow;
        } else if (btn.innerText === "EN ROUTE") { 
            btn.style.background = "#1e5c33"; btn.innerText = "ON SCENE"; 
            card.querySelector('#scne').innerText = timeNow;
        } else { card.remove(); }
    }

    function filterUnits() {
        const q = document.getElementById('unit-search').value.toUpperCase();
        const btns = document.querySelectorAll('.unit-btn');
        
        btns.forEach(btn => {
            const agency = btn.getAttribute('data-agency') || "";
            const unit = btn.getAttribute('data-unit') || "";
            const id = btn.getAttribute('data-id') || "";
            
            if (agency.includes(q) || unit.includes(q) || id.includes(q)) {
                btn.classList.remove('is-hidden');
            } else {
                btn.classList.add('is-hidden');
            }
        });
        
        if (q.length > 1) {
            document.querySelectorAll('.is-hidden').forEach(el => {
                if(el.classList.contains('unit-btn')) return;
                el.classList.remove('is-hidden');
            });
        }
    }

    window.onload = fetchData;
    setInterval(() => { 
        const clock = document.getElementById('clock');
        if(clock) clock.innerText = new Date().toLocaleTimeString('en-US', {hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'}); 
    }, 1000);
</script>
</body>
</html>